graph TB
    User["ðŸ‘¤ Users"]

    subgraph Client["Client Applications"]
        Apps["ðŸ“± Expo (Native) + ðŸŒ Expo Router (Web)"]
        Nav["ðŸ§­ Navigation\nStack: auth, (tabs), video-analysis, history-progress,\ncoaching-session, settings, onboarding/voice-selection\nTabs: record | coach | insights\nCustom BottomNavigation (Tamagui)"]
        Bundler["ðŸ“¦ Metro Bundler"]
        AuthGate["ðŸ” AuthGate (protected routes)"]
    end

    subgraph Packages["Shared Packages (@my/*)"]
        UI["ðŸŽ¨ @my/ui (Tamagui)\nBottomNavigationContainer\nVideoAnalysis UI: VideoPlayerSection,\nFeedbackSection, VideoControls, FeedbackPanel,\nCoachAvatar, AudioPlayer"]
        App["âš™ï¸ @my/app (Logic + Screens)\nCameraRecording (Expo/Vision camera,\nuploads â†’ /video-analysis)\nVideoAnalysisScreen (~825 LOC, leaf subscriptions)\nHistoryProgress (TanStack Query + Zustand cache\n+ thumbnail persistence)\nCoach (chat + sessions)\nInsights\nVoiceSelection (onboarding)"]
        API["ðŸ”Œ @my/api (Supabase client, queries,\nuploads, history, voice configs)"]
        Config["ðŸ§° @my/config (types/theme/MMKV)"]
        Logging["ðŸ“ @my/logging (structured logger)"]
    end

    subgraph State["State Management"]
        Zustand["ðŸ—ƒï¸ Zustand\nvideoPlayerStore (playback timeline)\nfeedbackCoordinatorStore (selection/bubbles)\nfeedbackAudioStore (audio URLs/paths, persisted)\npersistentProgressStore\nanalysisSubscription\nvideoHistoryStore (cache, persisted to MMKV)\nvoicePreferencesStore"]
        TSQ["ðŸ“Š TanStack Query\nanalysisJobStatus\nhistory cache prefilled from Zustand\nhistoricalAnalysis"]
    end

    subgraph Backend["Supabase Backend"]
        AuthSvc["ðŸ”‘ Auth (JWT + Sessions)"]
        DB[("ðŸ—„ï¸ PostgreSQL\nvideo_recordings\nanalysis_jobs\n  (+ voice snapshots)\n  status: queued | processing |\n    analysis_complete | completed | failed\nanalyses\nanalysis_feedback\nanalysis_audio_segments\nanalysis_ssml_segments\nanalysis_metrics\nupload_sessions\nprofiles (+ voice prefs)\ncoach_voice_configs\nuser_feedback\nðŸ”’ RLS Enabled\nðŸ”” Triggers:\n  INSERT â†’ /webhook\n  UPDATE (analysis_complete) â†’ /post-analyze")]
        Storage["ðŸ“ Storage\nraw videos\nprocessed audio\nthumbnails"]
        RT["âš¡ Realtime\nanalysis_jobs changes"]
        Edge["ðŸ§© Edge Functions\nai-analyze-video\n  /webhook (Phase 1)\n  /post-analyze (Phase 2)\nstorage-upload-finalize\nadmin-auth"]
    end

    subgraph AI["AI Pipeline (Split Architecture)"]
        ClientPose["ðŸ•º Client Pose (MoveNet)"]
        Phase1["ðŸ§  Phase 1: Video Analysis\n/webhook (INSERT trigger)\nGemini 2.5 Video + LLM feedback\n120s timeout protection\nStatus â†’ analysis_complete"]
        Phase2["ðŸŽµ Phase 2: SSML/Audio\n/post-analyze (UPDATE trigger)\nSSML generation â†’ Gemini TTS\nStatus â†’ completed"]
        VoiceConfig["ðŸŽ™ï¸ Voice Config\ncoach_voice_configs table\ngender/mode â†’ voice/prompt"]
    end

    User --> Apps
    Apps --> Nav
    Apps --> Bundler
    Nav --> AuthGate
    AuthGate --> UI
    AuthGate --> App
    App --> API
    App --> Zustand
    App --> TSQ
    App --> Logging
    UI --> Config
    API --> Config
    API --> AuthSvc
    API --> DB
    API --> Storage
    API --> RT
    API --> Edge
    ClientPose --> Phase1
    Edge --> Phase1
    Phase1 --> Phase2
    Phase2 --> Storage
    Phase1 --> DB
    Phase2 --> DB
    Phase1 --> VoiceConfig
    Phase2 --> VoiceConfig
    VoiceConfig --> DB
    DB --> RT
    RT --> TSQ

    classDef client fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef shared fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef state fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef ai fill:#fce4ec,stroke:#ad1457,stroke-width:2px

    class User,Apps,Nav,AuthGate client
    class UI,App,API,Config,Logging shared
    class Zustand,TSQ state
    class AuthSvc,DB,Storage,RT,Edge backend
    class ClientPose,Phase1,Phase2,VoiceConfig ai
