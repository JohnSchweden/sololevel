graph TB
    User["ðŸ‘¤ Users"]

    subgraph Client["Client Applications"]
        Apps["ðŸ“± Expo (Native) + ðŸŒ Expo Router (Web)"]
        Nav["ðŸ§­ Navigation\nStack: auth, (tabs), video-analysis, history-progress,\ncoaching-session, settings\nTabs: record | coach | insights\nCustom BottomNavigation (Tamagui)"]
        Bundler["ðŸ“¦ Metro Bundler"]
        AuthGate["ðŸ” AuthGate (protected routes)"]
    end

    subgraph Packages["Shared Packages (@my/*)"]
        UI["ðŸŽ¨ @my/ui (Tamagui)\nBottomNavigationContainer\nVideoAnalysis UI: VideoPlayerSection,\nFeedbackSection, VideoControls, FeedbackPanel"]
        App["âš™ï¸ @my/app (Logic + Screens)\nCameraRecording (Expo/Vision camera,\nuploads â†’ /video-analysis)\nVideoAnalysisScreen (111 LOC direct hooks,\nleaf store subscriptions)\nHistoryProgress (TanStack Query + Zustand cache\n+ thumbnail persistence)\nCoach (chat + sessions)\nInsights"]
        API["ðŸ”Œ @my/api (Supabase client, queries,\nuploads, history)"]
        Config["ðŸ§° @my/config (types/theme)"]
    end

    subgraph State["State Management"]
        Zustand["ðŸ—ƒï¸ Zustand\nvideoPlayerStore\nfeedbackCoordinatorStore\nfeedbackAudioStore\npersistentProgressStore\nanalysisSubscription\nvideoHistoryStore"]
        TSQ["ðŸ“Š TanStack Query\nanalysisJobStatus\nhistory cache prefilled from Zustand"]
    end

    subgraph Backend["Supabase Backend"]
        AuthSvc["ðŸ”‘ Auth (JWT + Sessions)"]
        DB[("ðŸ—„ï¸ PostgreSQL\nvideo_recordings\nanalysis_jobs\nanalyses\nanalysis_feedback\nanalysis_audio_segments\nanalysis_ssml_segments\nanalysis_metrics\nupload_sessions\nðŸ”’ RLS Enabled")]
        Storage["ðŸ“ Storage\nraw videos\nprocessed audio\nthumbnails"]
        RT["âš¡ Realtime\nanalysis_jobs changes"]
        Edge["ðŸ§© Edge Function\nai-analyze-video"]
    end

    subgraph AI["AI Pipeline"]
        ClientPose["ðŸ•º Client Pose (MoveNet)"]
        EdgeAI["ðŸ§  Edge Processing\nGemini 2.5 Video + LLM feedback\nGemini TTS â†’ audio"]
        SSMLW["ðŸ”¤ SSML Worker"]
        AudioW["ðŸ”Š Audio Worker"]
    end

    User --> Apps
    Apps --> Nav
    Apps --> Bundler
    Nav --> AuthGate
    AuthGate --> UI
    AuthGate --> App
    App --> API
    App --> Zustand
    App --> TSQ
    UI --> Config
    API --> Config
    API --> AuthSvc
    API --> DB
    API --> Storage
    API --> RT
    API --> Edge
    ClientPose --> EdgeAI
    Edge --> EdgeAI
    EdgeAI --> Storage
    EdgeAI --> DB
    EdgeAI --> SSMLW
    EdgeAI --> AudioW
    DB --> RT
    RT --> TSQ

    classDef client fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef shared fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef state fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef ai fill:#fce4ec,stroke:#ad1457,stroke-width:2px

    class User,Apps,Nav,AuthGate client
    class UI,App,API,Config shared
    class Zustand,TSQ state
    class AuthSvc,DB,Storage,RT,Edge backend
    class ClientPose,EdgeAI,SSMLW,AudioW ai
