graph TB
    User["ðŸ‘¤ Users"]

    subgraph Client["Client Applications"]
        Apps["ðŸ“± Expo (Native) + ðŸŒ Expo Router (Web)"]
        Bundler["ðŸ“¦ Metro Bundler"]
        Router["ðŸ§­ Expo Router
        (tabs) Layout:
        - record (Camera)
        - coach (AI Chat)
        - insights (Progress)
        BottomNavigation (Custom)"]
        Auth["ðŸ” AuthGate"]
    end

    subgraph Packages["Shared Packages (@my/*)"]
        UI["ðŸŽ¨ @my/ui (Tamagui)
        BottomNavigation
        BottomNavigationContainer"]
        App["âš™ï¸ @my/app (Logic + Screens)
        useTabPersistence (AsyncStorage)
        VideoAnalysisScreen (400 lines)
        â”œâ”€â”€ Direct Hook Composition
        â”œâ”€â”€ useVideoPlayback
        â”œâ”€â”€ useAudioController
        â”œâ”€â”€ useFeedbackCoordinator
        â”œâ”€â”€ useVideoControls
        â”œâ”€â”€ useVideoAudioSync
        â”œâ”€â”€ useFeedbackPanel
        â”œâ”€â”€ useGestureController
        â”œâ”€â”€ useAnimationController
        â””â”€â”€ VideoAnalysisLayout.native/web"]
        API["ðŸ”Œ @my/api (Supabase Client)"]
        Config["ðŸ§° @my/config (Types)"]
    end

    subgraph State["State Management"]
        Zustand["ðŸ—ƒï¸ Zustand (Client)"]
        TSQ["ðŸ“Š TanStack Query (Server)"]
    end

    subgraph Backend["Supabase Backend"]
        AuthSvc["ðŸ”‘ Auth (JWT + Sessions)"]
        DB[("ðŸ—„ï¸ PostgreSQL
        video_recordings
        analysis_jobs
        analysis_feedback
        analyses
        analysis_audio_segments
        analysis_ssml_segments
        analysis_metrics
        upload_sessions
        ðŸ”’ RLS Enabled")]
        Storage["ðŸ“ Storage
        raw: videos
        processed: audio
        thumbnails: images"]
        RT["âš¡ Realtime
        analysis_jobs changes"]
        Edge["ðŸ§© Edge Function
        ai-analyze-video"]
    end

    subgraph AI["AI Pipeline"]
        ClientPose["ðŸ•º Client Pose
        MoveNet Lightning"]
        EdgeAI["ðŸ§  Edge Processing
        Gemini 2.5 Video
        Gemini LLM Feedback
        Gemini TTS â†’ MP3/WAV"]
        SSMLW["ðŸ”¤ SSML Worker"]
        AudioW["ðŸ”Š Audio Worker"]
    end

    User --> Apps
    Apps --> Router
    Router --> Auth
    Auth --> UI
    Auth --> App
    App --> API
    App --> Zustand
    App --> TSQ
    UI --> Config
    API --> Config
    API --> AuthSvc
    API --> DB
    API --> Storage
    API --> RT
    API --> Edge
    ClientPose --> EdgeAI
    Edge --> EdgeAI
    EdgeAI --> Storage
    EdgeAI --> DB
    EdgeAI --> SSMLW
    EdgeAI --> AudioW
    DB --> RT
    RT --> TSQ

    classDef client fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef shared fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef state fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef ai fill:#fce4ec,stroke:#ad1457,stroke-width:2px

    class User,Apps,Router,Auth client
    class UI,App,API,Config shared
    class Zustand,TSQ state
    class AuthSvc,DB,Storage,RT,Edge backend
    class ClientPose,EdgeAI,SSMLW,AudioW ai
