graph TB
    User["👤 Users"]

    subgraph Client["Client Applications"]
        Apps["📱 Expo (Native) + 🌐 Expo Router (Web)"]
        Bundler["📦 Metro Bundler"]
        Router["🧭 Expo Router"]
        Auth["🔐 AuthGate"]
    end

    subgraph Packages["Shared Packages (@my/*)"]
        UI["🎨 @my/ui (Tamagui)"]
        App["⚙️ @my/app (Logic + Screens)"]
        API["🔌 @my/api (Supabase Client)"]
        Config["🧰 @my/config (Types)"]
    end

    subgraph State["State Management"]
        Zustand["🗃️ Zustand (Client)"]
        TSQ["📊 TanStack Query (Server)"]
    end

    subgraph Backend["Supabase Backend"]
        AuthSvc["🔑 Auth (JWT + Sessions)"]
        DB[("🗄️ PostgreSQL
        video_recordings
        analysis_jobs
        analysis_feedback
        analyses
        analysis_audio_segments
        analysis_ssml_segments
        analysis_metrics
        🔒 RLS Enabled")]
        Storage["📁 Storage
        raw: videos
        processed: audio"]
        RT["⚡ Realtime
        analysis_jobs changes"]
        Edge["🧩 Edge Function
        ai-analyze-video"]
    end

    subgraph AI["AI Pipeline"]
        ClientPose["🕺 Client Pose
        MoveNet Lightning"]
        EdgeAI["🧠 Edge Processing
        Gemini 2.5 Video
        Gemini LLM Feedback
        Gemini TTS → AAC/MP3"]
        SSMLW["🔤 SSML Worker"]
        AudioW["🔊 Audio Worker"]
    end

    User --> Apps
    Apps --> Router
    Router --> Auth
    Auth --> UI
    Auth --> App
    App --> API
    App --> Zustand
    App --> TSQ
    UI --> Config
    API --> Config
    API --> AuthSvc
    API --> DB
    API --> Storage
    API --> RT
    API --> Edge
    ClientPose --> EdgeAI
    Edge --> EdgeAI
    EdgeAI --> Storage
    EdgeAI --> DB
    EdgeAI --> SSMLW
    EdgeAI --> AudioW
    DB --> RT
    RT --> TSQ

    classDef client fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef shared fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef state fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef ai fill:#fce4ec,stroke:#ad1457,stroke-width:2px

    class User,Apps,Router,Auth client
    class UI,App,API,Config shared
    class Zustand,TSQ state
    class AuthSvc,DB,Storage,RT,Edge backend
    class ClientPose,EdgeAI ai
