graph TB
    User["ğŸ‘¤ Users"]

    subgraph "Client Applications"
        ExpoApp["ğŸ“± Expo App (iOS/Android)"]
        NextApp["ğŸŒ Next.js App (Web SSR/SSG)"]
        ExpoRouter["ğŸ§­ Expo Router (Universal Routing)"]
        subgraph AuthLayer["ğŸ” Authentication Layer"]
            AuthGate["ğŸšª AuthGate (Route Protection + Loading)"]
            NextMiddleware["âš™ï¸ Next.js Middleware (Server Auth)"]
            SignInScreens["ğŸ“ Sign-in Screens (Expo + Next.js)"]
        end
    end

    subgraph "Shared Packages (@my/*)"
        UIPkg["ğŸ¨ @my/ui (Tamagui Components)"]
        AppPkg["âš™ï¸ @my/app (Business Logic, Screens, Hooks)"]
        subgraph AuthPkg["ğŸ” Authentication (@my/app + @my/api)"]
            UseAuth["ğŸª useAuth Hook (React + Zustand)"]
            AuthClient["ğŸ”Œ Auth Client (Typed Wrapper)"]
            TestBootstrap["ğŸ§ª Test Auth Bootstrap (Dev Mode)"]
            RLSHelpers["ğŸ›¡ï¸ RLS Helpers (Security)"]
        end
        APIPkg["ğŸ”Œ @my/api (Supabase Client)"]
        ConfigPkg["ğŸ§° @my/config (Config & Types)"]
    end

    subgraph "State & Data"
        Zustand["ğŸ—ƒï¸ Zustand (Client State)"]
        TSQ["ğŸ“Š TanStack Query (Server State)"]
    end

    subgraph "Supabase Backend"
        subgraph AuthBackend["ğŸ” Authentication Backend"]
            Auth["ğŸ”‘ Supabase Auth (JWT, Sessions)"]
            AuthPolicies["ğŸ›¡ï¸ RLS Policies (auth.uid() = user_id)"]
        end
        subgraph DBGroup["ğŸ—„ï¸ PostgreSQL (RLS Enforced)"]
            DB[("public schema")]
            VR["ğŸ“„ video_recordings (id, user_id, storage_path, duration) ğŸ”’ RLS"]
            AJ["ğŸ“„ analysis_jobs (id, user_id, video_recording_id, status, results, pose_data) ğŸ”’ RLS"]
        end
        Storage["ğŸ“ Storage (raw: uploads â€¢ processed: AAC/MP3)"]
        subgraph RTGroup["âš¡ Realtime"]
            RT1["Postgres Changes (analysis_jobs UPDATE)"]
            RT2["Broadcast Channel (pose-data)"]
        end
        subgraph EdgeFns["ğŸ§© Edge Functions"]
            E1["ai-analyze-video"]
            E1a["POST /ai-analyze-video ğŸ”’ JWT â†’ userId"]
            E1b["GET /ai-analyze-video/status?id=<id>"]
            E1c["POST /ai-analyze-video/tts"]
            E1d["GET /ai-analyze-video/health"]
            Obs["ğŸ“ Logger (_shared/logger.ts)"]
        end
        subgraph Providers["ğŸ”— OAuth / OTP (Postâ€‘MVP)"]
            Apple[" Apple"]
            Google["G Google"]
            MagicLink["âœ‰ï¸ Magic Link (OTP)"]
        end
    end

    subgraph "AI Analysis Pipeline (Hybrid)"
        subgraph ClientSide["Client Responsibilities"]
            Pose["ğŸ•º Pose Detection (VisionCamera/MoveNet)"]
        end
        subgraph EdgeSide["Edge Responsibilities"]
            LLM["ğŸ§  Gemini 2.5 (Video Analysis)"]
            SSML["ğŸ”¤ SSML Generation (Gemini LLM)"]
            TTS["ğŸ”Š TTS Generation (Gemini 2.0 â†’ AAC/MP3)"]
            RPC1["RPC: store_analysis_results"]
            RPC2["RPC: get_enhanced_analysis_with_feedback"]
        end
    end

    subgraph "Dev â€¢ Build â€¢ Quality"
        Turbo["âš¡ Turbo (Orchestration)"]
        Yarn["ğŸ§¶ Yarn 4 (Workspaces)"]
        TS["ğŸ“ TypeScript (Strict)"]
        Biome["âœ¨ Biome (Lint/Format)"]
        subgraph TestingInfra["ğŸ§ª Testing Infrastructure"]
            Vitest["ğŸ§ª Vitest (Unit Tests)"]
            Jest["ğŸƒ Jest (RN Tests)"]
            Playwright["ğŸ­ Playwright (E2E + Pre-auth)"]
            TestUser["ğŸ‘¤ Test User Seeding"]
        end
        GHA["âš™ï¸ GitHub Actions (CI)"]
        EAS["ğŸ“¦ EAS (Native Builds)"]
        Vercel["â–² Vercel (Web Deploy)"]
    end

    User --> ExpoApp
    User --> NextApp
    ExpoApp --> ExpoRouter
    NextApp --> ExpoRouter
    ExpoRouter --> AuthLayer
    AuthLayer --> UIPkg
    AuthLayer --> AppPkg
    ExpoApp --> UIPkg
    NextApp --> UIPkg
    ExpoApp --> AppPkg
    NextApp --> AppPkg
    AppPkg --> AuthPkg
    AppPkg --> APIPkg
    UIPkg --> ConfigPkg
    APIPkg --> ConfigPkg
    ExpoApp --> Zustand
    NextApp --> Zustand
    ExpoApp --> TSQ
    NextApp --> TSQ
    APIPkg --> AuthBackend
    APIPkg --> DB
    APIPkg --> Storage
    APIPkg --> RTGroup
    APIPkg --> EdgeFns
    AuthLayer --> AuthPkg
    AuthPkg --> AuthBackend
    AuthClient --> Auth
    UseAuth --> AuthClient
    TestBootstrap --> AuthClient
    RLSHelpers --> AuthPolicies
    AuthBackend --> DBGroup
    AuthBackend --> Providers
    EdgeFns --> Auth
    ClientSide --> EdgeSide
    Storage <--> EdgeFns
    EdgeFns --> DBGroup
    EdgeSide --> Storage
    EdgeSide --> RPC1
    EdgeSide --> RPC2
    DBGroup --> RTGroup
    RTGroup --> TSQ
    AuthPolicies --> VR
    AuthPolicies --> AJ
    VR --> AJ
    Turbo --> ExpoApp
    Turbo --> NextApp
    Turbo --> UIPkg
    Turbo --> AppPkg
    Turbo --> APIPkg
    Yarn --> Turbo
    TS --> Turbo
    Biome --> Turbo
    TestingInfra --> AuthPkg
    Vitest --> AppPkg
    Vitest --> APIPkg
    Jest --> AuthPkg
    Playwright --> AuthLayer
    TestUser --> Auth
    GHA --> Turbo
    EAS --> ExpoApp
    Vercel --> NextApp

    classDef layerClient fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef layerShared fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef layerState fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef layerBackend fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef layerAI fill:#fce4ec,stroke:#ad1457,stroke-width:2px
    classDef layerDev fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef layerAuth fill:#fff8e1,stroke:#f57f17,stroke-width:3px

    class ExpoApp,NextApp,ExpoRouter layerClient
    class AuthLayer,AuthGate,NextMiddleware,SignInScreens layerAuth
    class UIPkg,AppPkg,APIPkg,ConfigPkg layerShared
    class AuthPkg,UseAuth,AuthClient,TestBootstrap,RLSHelpers layerAuth
    class Zustand,TSQ layerState
    class AuthBackend,Auth,AuthPolicies,DBGroup,Storage,RTGroup,EdgeFns layerBackend
    class Pose,LLM,SSML,TTS,RPC1,RPC2 layerAI
    class Turbo,Yarn,TS,Biome,TestingInfra,Vitest,Jest,Playwright,TestUser,GHA,EAS,Vercel layerDev