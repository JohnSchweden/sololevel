flowchart TD
    %% Entry & Auth
    subgraph Entry ["ðŸš€ Entry & Auth"]
        Launch[App Launch]
        AuthGate[AuthGate -> Sign-in or auto-login]
    end
    Launch --> AuthGate

    %% Tab Layout
    subgraph Tabs ["ðŸ“± Tab Layout (protected)"]
        RecordTab[Record Tab (camera/upload)]
        CoachTab[Coach Tab (chat UI)]
        InsightsTab[Insights Tab]
    end
    AuthGate --> RecordTab
    AuthGate --> CoachTab
    AuthGate --> InsightsTab

    %% Record & Upload
    subgraph RecordFlow ["ðŸŽ¥ Record & Upload"]
        CameraView[Camera preview + controls]
        StartRec[Start recording]
        Recording[Recording active]
        PauseResume[Pause/Resume]
        StopRec[Stop & save locally]
        MediaPicker[Native media picker upload]
        Upload[Upload + Supabase analysis job]
        ToAnalysis[Push /video-analysis]
        HistoryShortcut[History/Progress shortcut]
    end
    RecordTab --> CameraView
    CameraView --> StartRec
    StartRec --> Recording
    Recording --> PauseResume
    Recording --> StopRec
    CameraView --> MediaPicker
    StopRec --> Upload
    MediaPicker --> Upload
    Upload --> ToAnalysis
    CameraView --> HistoryShortcut

    %% Video Analysis
    subgraph AnalysisFlow ["ðŸ§  Video Analysis"]
        AnalysisRoute[VideoAnalysis route]
        Processing[Upload/processing state]
        Player[Video player + controls]
        FeedbackPanel[Feedback panel bottom sheet]
        AudioFeedback[Audio feedback + timeline sync]
        ReturnCamera[Return to camera (reset to idle)]
    end
    ToAnalysis --> AnalysisRoute
    AnalysisRoute --> Processing
    Processing --> Player
    Player --> FeedbackPanel
    FeedbackPanel --> Player
    Player --> AudioFeedback
    AnalysisRoute --> ReturnCamera

    %% History & Progress
    subgraph HistoryRoute ["ðŸ“‚ History & Progress"]
        HistoryScreen[HistoryProgress screen (prefetch + open past analysis)]
        HistoryDetail[Open past analysis â†’ /video-analysis]
    end
    HistoryShortcut --> HistoryScreen
    HistoryScreen --> HistoryDetail
    HistoryDetail --> AnalysisRoute

    %% Settings Stack
    subgraph Settings ["âš™ï¸ Settings Stack"]
        SettingsHome[Settings home]
        SettingsDetail[Account/Personalisation/Data/Security/About]
    end
    HistoryScreen -. "profile icon" .-> SettingsHome
    SettingsHome --> SettingsDetail

    %% Coach
    subgraph Coach ["ðŸ† Coach"]
        CoachTab --> CoachChat[Chat UI (static mock responses)]
        CoachChat --> CoachSuggestions[Suggestion chips]
    end

    %% Insights
    subgraph Insights ["ðŸ“Š Insights"]
        InsightsTab --> InsightsUI[Static charts from mock data]
    end

    %% Pending / Not Implemented
    subgraph Pending ["ðŸš§ Not implemented"]
        Notifications[Notifications menu/actions]
        SideSheet[Legacy side sheet navigation]
        MirrorMode[Coach mirror mode]
    end

    %% Styling / Status
    classDef live fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef partial fill:#fff8e1,stroke:#f57f17,stroke-width:2px
    classDef mock fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef pending fill:#ffebee,stroke:#c62828,stroke-width:2px

    %% Legend
    subgraph Legend ["Legend"]
        LegendLive[Live]
        LegendMock[Mock UI]
        LegendPending[Not implemented]
    end
    class LegendLive live
    class LegendMock mock
    class LegendPending pending

    class Launch,AuthGate,RecordTab,CameraView,StartRec,Recording,PauseResume,StopRec,MediaPicker,Upload,ToAnalysis,AnalysisRoute,Processing,Player,FeedbackPanel,AudioFeedback,ReturnCamera,HistoryScreen,HistoryDetail,SettingsHome,SettingsDetail live
    class CoachChat,CoachSuggestions,InsightsUI mock
    class Notifications,SideSheet,MirrorMode pending