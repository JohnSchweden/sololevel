---
description: Monorepo foundation & architecture
alwaysApply: true
globs: ["**/*"]
---

## Purpose
Establishes a unified foundation for architectural principles, repository structure, and data/security model. Major technical decisions documented in `docs/spec/` (PRD/TRD) and project overview in root `AGENTS.md`. Complements `core/development-operations.mdc` for operational workflows.

**Related:** `core/development-operations.mdc`, `quality/testing-unified.mdc`, `quality/error-handling.mdc`, `quality/performance.mdc`, `backend/supabase-backend.mdc`, `backend/supabase-database.mdc`

## Monorepo Structure
```
project-root/
├── apps/          # Applications
│   ├── expo/      # React Native app (expo-app)
│   └── web/       # Expo Router web app (web-app)
├── packages/      # Shared code
│   ├── ui/        # Tamagui components (@my/ui)
│   ├── app/       # Business logic, screens, hooks (@my/app)
│   ├── api/       # Backend integrations & clients (@my/api)
│   ├── config/    # Configuration & types (@my/config)
│   └── logging/   # Cross-platform structured logger (@my/logging)
├── docs/          # Documentation
├── supabase/      # Backend configuration
└── .cursorrules   # AI behavior configuration
```

Scaffolding: use `yarn turbo gen` where applicable.

## Data Flow

1. **Client Data Fetching:** Client → TanStack Query → Supabase Client → PostgreSQL
2. **Realtime Updates:** PostgreSQL → Supabase Realtime → Client subscription
3. **File Handling:** Client → Supabase Storage → CDN
4. **Sensitive Operations:** Client → Supabase Edge Functions → Database/Services

## Security Model

- **Row Level Security (RLS):** Enabled by default for all tables
- **Authentication:** JWT-based via Supabase Auth
- **Privileged Logic:** Use Edge Functions for sensitive operations; never expose secrets in client code
- **Secrets Management:** Store secrets in environment variables. Never commit `.env*` files to version control

See `quality/security-best-practices.mdc` and `SECURITY.md` for detailed security practices.

## Performance Guardrails

- Component optimization: `React.memo` for expensive components with stable props
- Large data sets: virtualized lists for efficient rendering
- Code splitting: dynamic imports and tree-shake unused exports
- Asset optimization: optimized image formats, CDN-backed assets
- Caching: edge caching for static content

**Performance Budgets:**
- Web (Expo Router): Main route JS bundle ≤ 250KB gzipped; review weekly
- Native (Expo): Avoid large monolithic imports; prefer code splitting
- Images: Use optimized formats and restrict remote image sizes

See `quality/performance.mdc` for more details.

## Architectural Extension Guidelines

- **Feature Screens:** Add new screens to `packages/app`; consume from `apps/*`
- **Shared UI:** Place reusable UI in `packages/ui`; avoid app-specific styles here
- **Backend Access:** Route all backend calls through `packages/api`; do not fetch directly from UI
- **Configuration & Types:** Centralize in `packages/config` for cross-package sharing
- **Logging:** Use `packages/logging` for all structured logging; provides cross-platform logger with dev/prod gating
- **Path Aliases:** Update `tsconfig.base.json` with new aliases when adding packages

### Adding a New Package
1. Create `packages/<name>` with `package.json` (type: module) and `tsconfig.json`
2. Add to root `workspaces`; set internal dependencies using `"workspace:*"`
3. Define path alias in `tsconfig.base.json` (e.g., `@name/*`)
4. Use named exports only; avoid default exports
5. Add minimal tests and stories (for UI), then run `yarn type-check`
6. Build with Turbo and ensure consumers import via the alias

### Package Naming Conventions
- **Apps:** `expo-app`, `web-app` (match directory names)
- **Shared Packages:** `@my/ui`, `@my/app`, `@my/api`, `@my/config`, `@my/logging`
- **Internal Dependencies:** Use `workspace:*`
- **Privacy:** All packages must include `"private": true` in `package.json`

## Import Strategy & Package Resolution

**See root `AGENTS.md` "Import Strategy" section** for package-level vs path-level import patterns and rules.

## Versioning & Compatibility

- Align Expo SDK versions across `apps` and `packages`
- Pin critical dependencies; use carets only for utilities
- Document breaking changes in `CHANGELOG.md`
- **Version Matrix:** See root `AGENTS.md` "Version Matrix" section for current versions and compatibility requirements