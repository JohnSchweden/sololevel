---
description: Auto-load scoped AGENTS.md + self-healing with decision trees
alwaysApply: true
globs: ["**/*"]
---

# Scoped AGENTS.md with Self-Healing

## ğŸ¯ Context Auto-Loading (Happens Automatically)

**Root AGENTS.md** is always loaded. Then, the most specific scoped `AGENTS.md` for your working directory:

- `apps/**/*` â†’ `@apps/AGENTS.md`
- `packages/**/*` â†’ `@packages/AGENTS.md`
- `packages/app/**/*` â†’ `@packages/app/AGENTS.md` â­ (most specific wins)
- `packages/api/**/*` â†’ `@packages/api/AGENTS.md`
- `packages/ui/**/*` â†’ `@packages/ui/AGENTS.md`
- `supabase/**/*` â†’ `@supabase/AGENTS.md`

**Precedence:** More specific > Less specific > Root
Example: `packages/ui/AGENTS.md` > `packages/AGENTS.md` > root `AGENTS.md`

---

## ğŸ”€ Quick Decision Trees

### 1. Which validation command?
```
Single file change?
   â†“
   yarn biome check <file>

Workspace changes?
   â†“
   yarn type-check:<workspace> + yarn lint:<workspace>

Pre-commit/CI?
   â†“
   yarn type-check:all + yarn lint:all
```

### 2. Where to save this learning?
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ I fixed a mistake!  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â†’ Agent process? (validation, tools)
           â”‚   â””â”€â†’ Root AGENTS.md Â§ Agent Behavior
           â”‚
           â”œâ”€â†’ Repo architecture? (navigation, New Arch)
           â”‚   â””â”€â†’ Root AGENTS.md Â§ Architecture
           â”‚
           â”œâ”€â†’ Workspace-specific? (UI tokens, app state)
           â”‚   â””â”€â†’ packages/<workspace>/AGENTS.md
           â”‚
           â”œâ”€â†’ General pattern? (React, TypeScript)
           â”‚   â””â”€â†’ .cursor/rules/quality/*.mdc or core/*.mdc
           â”‚
           â””â”€â†’ File-specific / one-time issue?
               â””â”€â†’ Don't document (not reusable)
```

---

## ğŸ”§ Self-Healing Workflow

### When to Self-Heal
Trigger self-healing when you:
- Make a mistake and later correct it
- Discover a reusable pattern to avoid future issues
- Learn something that would help the next time

### 4-Step Process
1. **Correct** the mistake in current work
2. **Route** to appropriate file using decision tree above
3. **Update** that file (match existing style)
4. **Stop** â€” don't duplicate or over-document

### Pattern Examples

#### Example 1: Wrong import pattern
```typescript
// âŒ You initially wrote:
import { Button } from '../../../ui/components/Button'

// âœ… Corrected to:
import { Button } from '@ui/components/Button'
```

**Self-healing action:**
```markdown
Add to packages/AGENTS.md:

## Import Patterns
- **Cross-package imports:** Always use path aliases (`@ui/`, `@app/`). Never use relative imports (`../../../`)
```

#### Example 2: Wrong validation scope
```bash
# âŒ You ran:
yarn type-check  # Full codebase (slow, unrelated errors)

# âœ… Should have run:
yarn type-check:ui  # Workspace only
```

**Self-healing action:**
```markdown
Add to root AGENTS.md Â§ Validation Strategy:

- **packages/ui/** changes: Use `yarn type-check:ui` (not full `yarn type-check`)
```

#### Example 3: Claimed success without verification
```markdown
# âŒ You wrote:
"Types look good âœ“"

# âœ… Should have written:
"Running type check..."
[Shows: yarn type-check:ui output]
"Type check passed: 0 errors"
```

**Self-healing action:**
```markdown
Strengthen root AGENTS.md Â§ Verification Transparency:

- **Show commands:** Always display exact command executed
- **Show output:** Include complete terminal output
- **Never simulate:** Actually run checks, don't describe them
```

---

## ğŸ“ Recording Format (Match Destination Style)

### For AGENTS.md files (terse bullets)
```markdown
## Relevant Section
- **Pattern name**: Brief explanation (why it matters)
```

### For .mdc rule files (bullets + examples)
```markdown
## Relevant Section
- **Pattern name**: Explanation

  **Wrong:**
  ```typescript
  // problematic code
  ```

  **Correct:**
  ```typescript
  // fixed code
  ```
```

---

## âœ… Quality Gates (Before Updating)

**Ask yourself:**
- [ ] Is this pattern **reusable**? (not file-specific)
- [ ] Does it already exist? (update, don't duplicate)
- [ ] Does tone match target file? (AGENTS.md = terse; .mdc = explanatory)
- [ ] Will this help prevent similar mistakes?

**If ANY checkbox is NO â†’ Skip the update**

---

## ğŸ¯ Common Agent Mistakes & Auto-Corrections

### Mistake: "I'll check that"
**Problem:** Claiming intent without execution

**Auto-correction:**
```markdown
Before: "I'll verify the types are correct"

After: [Executes yarn type-check:ui]
       $ yarn type-check:ui
       [Shows complete output]
       "Found 2 type errors in Button.tsx..."
```

### Mistake: Over-formatting
**Problem:** Bullet points for simple answers

**Auto-correction:**
- If user asks simple/conversational question â†’ Use prose
- Use bullets ONLY for:
  - Explicit user request for list
  - Multi-step instructions (3+ steps)
  - Comparison of 3+ items

### Mistake: No evidence
**Problem:** "Validation passed" without showing output

**Auto-correction:**
```markdown
NEVER write: "Tests passed âœ“"

ALWAYS write:
$ yarn workspace @my/ui test Button.test.tsx
PASS packages/ui/components/Button.test.tsx
  âœ“ renders button text (23ms)
  âœ“ calls onClick handler (18ms)

Tests: 2 passed, 2 total
Time: 1.234s
```

---

## ğŸ—‚ï¸ Routing Table (Detailed)

| Mistake Scope | Target File | Section |
|---------------|-------------|---------|
| Agent process (tool usage, verification) | Root `AGENTS.md` | Â§ Agent Behavior |
| Repo architecture (navigation, New Arch) | Root `AGENTS.md` | Â§ Architecture |
| App patterns (route wrappers, configs) | `apps/AGENTS.md` | Relevant section |
| Package-general (testing, structure) | `packages/AGENTS.md` | Relevant section |
| UI-specific (Tamagui, platform diffs) | `packages/ui/AGENTS.md` | Appropriate section |
| App logic (state, effects) | `packages/app/AGENTS.md` | Â§ State or new |
| API/auth patterns | `packages/api/AGENTS.md` | Â§ Authentication |
| Supabase backend (RLS, Edge Fns) | `supabase/AGENTS.md` | Relevant section |
| General React patterns | `.cursor/rules/quality/performance.mdc` | Add bullet + example |
| TypeScript patterns | `.cursor/rules/core/typescript-standards.mdc` | Relevant section |

---

## ğŸš¨ Enforcement (Critical Errors)

- **Not reading relevant AGENTS.md** = Critical error
- **Not self-healing after reusable mistake** = Critical error
- **Not verifying architecture** after code changes = Critical error

**Required architecture check:** Read `docs/spec/architecture.mermaid` after changes to:
- Database schema
- API endpoints
- Component boundaries
- Data flow patterns

---

## ğŸ“‚ Storage Hierarchy Reference

- `AGENTS.md` â€” Root (agent behavior, repo architecture)
- `apps/AGENTS.md` â€” App-level (Expo + Web apps)
- `packages/AGENTS.md` â€” Package-general (shared patterns)
- `packages/app/AGENTS.md` â€” Business logic, state, screens
- `packages/api/AGENTS.md` â€” Backend, auth, Supabase
- `packages/ui/AGENTS.md` â€” Tamagui, cross-platform UI
- `supabase/AGENTS.md` â€” Database, triggers, Edge Functions
- `.cursor/rules/quality/*.mdc` â€” General coding patterns
- `.cursor/rules/core/*.mdc` â€” Foundational standards