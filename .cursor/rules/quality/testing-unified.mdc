---
description: Unified testing strategy coordinator for Jest and Vitest environments
globs: ["**/*.test.*", "**/*.spec.*"]
alwaysApply: false
references: ["quality/testing/testing-patterns", "quality/testing/testing-react-native", "quality/testing/testing-web", "quality/testing/testing-setup", "quality/testing/testing-troubleshooting", "quality/testing/testing-metrics"]
---

# Modern Testing Strategy (Unified Coordinator)

## ğŸ¯ Core Philosophy
**Test user behavior, not implementation. Focus on what users would notice if it broke.**

### Package-Specific Test Runner Selection
- **packages/ui** (Shared UI Components): Jest with jsdom â†’ Web component testing â†’ See `quality/testing/testing-web.mdc`
- **packages/app** (Business Logic & Screens): Jest with jsdom â†’ React Native app testing â†’ See `quality/testing/testing-react-native.mdc`
- **packages/api** (Backend Integration): Vitest â†’ Node.js API testing â†’ See `quality/testing/testing-web.mdc`
- **supabase/shared/** (Cross-platform utilities): Vitest â†’ Node.js testing
- **supabase/functions/_shared** (Domain-specific logic): Vitest â†’ Node.js testing
- **supabase/functions/** (Edge entrypoints): Deno test runner for Edge runtime behavior

**Enforcement**: Import validation in CI/CD pipeline prevents architectural violations.
- **apps/expo** (React Native App): Jest with jest-expo preset â†’ Full RN app testing â†’ See `quality/testing/testing-react-native.mdc`
- **apps/next** (Web App): Vitest â†’ Web app testing â†’ See `quality/testing/testing-web.mdc`
- **NEVER mix**: Don't use Vitest for React Native or Jest for pure Node.js testing

### Critical Success Patterns
- **packages/ui**: DOM-based queries with `data-testid` â†’ See `quality/testing/testing-web.mdc`
- **packages/app**: Accessibility-based queries with `getByLabelText()` â†’ See `quality/testing/testing-react-native.mdc`
- **packages/api**: Standard Node.js testing patterns â†’ See `quality/testing/testing-web.mdc`

## ğŸ“‹ Quick Reference

### Before Writing Tests
1. **IDENTIFY your package** and select the correct testing environment from the table above
2. **READ** `quality/testing/testing-patterns.mdc` for AAA pattern and best practices
3. **FOLLOW** the package-specific patterns listed above
4. **CONSULT** `docs/workflow/custom_modes/tester.md` for TDD workflow and package guidance

### Test Efficiency Rules
- **Runner discipline**: Run tests per workspace with the correct runner; do not pass global flags across workspaces. Example:
  - `yarn workspace @my/app test`
  - `yarn workspace @my/ui test`
  - `yarn workspace @my/api test`
- **Ratio**: 1:2 test-to-code maximum â†’ See `quality/testing/testing-patterns.mdc`
- **Focus**: User-visible behavior only; avoid asserting internal implementation details (e.g., UUID resolution steps) â†’ See `quality/testing/testing-patterns.mdc`
- **Mock**: External dependencies only; centralize typed mocks in test-utils. Use `Parameters<>`/`ReturnType<>` to type jest.fn â†’ See `quality/testing/testing-setup.mdc`
- **Environment**: Use package-appropriate mocks (DOM for ui, RN components for app, Node for api). Do not modify shared test-utils in feature PRs
- **Timers**: Prefer `waitFor` over fake timers. If using fake timers, advance deterministically; never mix `runAllTimers()` with unresolved promises
- **Convert**: Complex failing tests to integration tests â†’ See `quality/testing/testing-troubleshooting.mdc`
- **Orchestration vs logic**: Screens are thin orchestrators; put logic in hooks/stores and unit-test those thoroughly

## ğŸ”— Sub-Rule Quicklinks

Jump directly to detailed guidance for each testing area:

### ğŸ§© Core Patterns & Organization
- **[AAA Pattern, Naming, Data-Driven, Isolation](quality/testing/testing-patterns.mdc)**
  - Mandatory Arrange-Act-Assert structure
  - Consistent test naming and organization
  - Data-driven and table-based test strategies
  - Ensuring test independence

### ğŸ“± React Native Testing (Jest)
- **[React Native Patterns & Anti-Patterns](quality/testing/testing-react-native.mdc)**
  - Accessibility-first queries (e.g., `getByLabelText`)
  - Tamagui component testing
  - Event simulation with `fireEvent.press()`
  - Common pitfalls to avoid in RN testing

### ğŸŒ Web Testing (Vitest)
- **[Web Component & Logic Testing](quality/testing/testing-web.mdc)**
  - jsdom-based component tests
  - Business logic and browser API mocking
  - Web-specific best practices

### âš™ï¸ Environment Setup
- **[Test Runner & Mock Configuration](quality/testing/testing-setup.mdc)**
  - Jest setup for React Native
  - Vitest setup for web/Node
  - Required mocks and setup files
  - Manual vs. automatic mocking

### ğŸ› ï¸ Troubleshooting & Debugging
- **[Common Issues & Solutions](quality/testing/testing-troubleshooting.mdc)**
  - Frequent error patterns and fixes
  - Query and mock troubleshooting
  - Performance and debugging tips

### ğŸ“Š Success Metrics & Validation
- **[Metrics, Coverage, Review](quality/testing/testing-metrics.mdc)**
  - Key success patterns and validation checklists
  - Coverage requirements
  - Ongoing review and maintenance guidelines

## ğŸš€ Quick Start Checklist
â–¡ **Identify your package** and choose the correct testing environment:
   - packages/ui: Jest + @testing-library/react + jsdom
   - packages/app: Jest + @testing-library/react-native + jsdom
   - packages/api: Vitest + native Node testing
   - apps/expo: Jest + jest-expo + @testing-library/react-native
   - apps/next: Vitest + @testing-library/react
   - supabase/shared: Vitest (Node)
   - supabase/functions/_shared: Vitest (Node)
   - supabase/functions (Edge): Deno test runner
â–¡ Follow AAA pattern with clear comments
â–¡ Use appropriate query patterns for your package (data-testid for ui, getByLabelText for app)
â–¡ Mock external dependencies only (APIs, native modules, libraries)
â–¡ Use package-appropriate mocks (DOM for ui, RN components for app, Node for api)
â–¡ Maintain 1:2 test-to-code ratio
â–¡ Test user behavior, not implementation

## ğŸ¯ Success Metrics Summary
## ğŸ”’ CI Enforcement
- Fail CI on presence of `describe.only`/`it.only`/`test.only` or any `.skip` committed in app packages
- Require `yarn type-check:all`, `yarn lint:all`, and `yarn build` to pass before running tests
- Changes to `packages/ui/src/test-utils/**` require running `yarn type-check` for all workspaces and code-owner review
â†’ See `quality/testing/testing-metrics.mdc` for comprehensive success metrics and validation

## ğŸ”„ Rule Updates
This rule coordinates focused sub-rules. Update specific patterns in their respective sub-rule files:
- Add new patterns to `testing-patterns.mdc`
- Update React Native issues in `testing-react-native.mdc`
- Add troubleshooting to `testing-troubleshooting.mdc`
- Update metrics in `testing-metrics.mdc`

**Last Coordinated**: September 2025 - Package-specific testing environments implemented
- packages/ui: Web component testing (Jest + jsdom)
- packages/app: React Native app testing (Jest + RN Testing Library)
- packages/api: Node.js API testing (Vitest)
- apps/expo: Full React Native app testing (Jest + jest-expo)
- apps/next: Web app testing (Vitest)

â†’ See `quality/testing/testing-metrics.mdc` for performance and maintenance guidelines
